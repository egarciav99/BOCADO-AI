# 游 Modelo de Datos

## Firestore Collections

### `users` (documento por usuario)

```typescript
interface User {
  uid: string;
  email: string;
  displayName: string;
  photoURL?: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;

  // Perfil nutricional
  profile: {
    // Datos b치sicos
    birthDate: Date;
    gender: "male" | "female" | "other";
    height: number; // cm
    weight: number; // kg
    activityLevel:
      | "sedentary"
      | "light"
      | "moderate"
      | "active"
      | "very_active";

    // Condiciones y restricciones
    medicalConditions: string[]; // ['diabetes', 'hypertension']
    allergies: string[]; // ['nuts', 'dairy', 'gluten']
    dietaryPreferences: string[]; // ['vegetarian', 'keto']

    // Objetivos
    goal: "lose_weight" | "maintain" | "gain_muscle" | "improve_health";
    targetWeight?: number;

    // Preferencias
    cuisinePreferences: string[]; // ['mexican', 'italian']
    dislikedFoods: string[]; // ['broccoli', 'liver']
    cookingTime: "quick" | "medium" | "no_rush"; // preferencia de tiempo
    budget: "low" | "medium" | "high";
  };

  // Settings
  settings: {
    notifications: boolean;
    language: "es" | "en";
    theme: "light" | "dark" | "system";
  };
}
```

### `recipes` (subcollection: `users/{userId}/recipes`)

```typescript
interface Recipe {
  id: string;
  createdAt: Timestamp;

  // Metadata
  title: string;
  description: string;
  imageURL?: string;
  cuisine: string;
  mealType: "breakfast" | "lunch" | "dinner" | "snack";
  cookingTime: number; // minutos
  difficulty: "easy" | "medium" | "hard";
  servings: number;

  // Ingredientes
  ingredients: {
    name: string;
    amount: number;
    unit: string;
    category: string;
    isInPantry: boolean;
  }[];

  // Nutrici칩n
  nutrition: {
    calories: number;
    protein: number; // g
    carbs: number; // g
    fat: number; // g
    fiber?: number;
    sugar?: number;
    sodium?: number;
  };

  // Preparaci칩n
  instructions: string[];
  tips?: string[];
  tags: string[];

  // AI metadata
  generatedBy: "gemini" | "manual";
  promptUsed?: string;

  // User interaction
  isFavorite: boolean;
  lastCooked?: Timestamp;
  rating?: number; // 1-5
  notes?: string;
}
```

### `pantry` (subcollection: `users/{userId}/pantry`)

```typescript
interface PantryItem {
  id: string;
  name: string;
  category:
    | "vegetables"
    | "fruits"
    | "meat"
    | "seafood"
    | "dairy"
    | "grains"
    | "legumes"
    | "spices"
    | "oils"
    | "condiments"
    | "beverages"
    | "other";

  // Cantidad
  quantity: number;
  unit: string;

  // Ubicaci칩n
  zone: "fridge" | "freezer" | "pantry" | "counter";

  // Fechas
  addedAt: Timestamp;
  expiresAt?: Timestamp;

  // Opcional
  brand?: string;
  notes?: string;
}
```

### `mealPlans` (subcollection: `users/{userId}/mealPlans`)

```typescript
interface MealPlan {
  id: string;
  weekStart: Timestamp;
  createdAt: Timestamp;

  // Plan semanal
  days: {
    [day: string]: {
      // 'monday', 'tuesday', etc.
      breakfast?: RecipeSummary;
      lunch?: RecipeSummary;
      dinner?: RecipeSummary;
      snacks?: RecipeSummary[];
    };
  };

  // Metadata
  isAutoGenerated: boolean;
  nutritionSummary?: {
    dailyCalories: number;
    dailyProtein: number;
    dailyCarbs: number;
    dailyFat: number;
  };
}

type RecipeSummary = {
  recipeId: string;
  title: string;
  imageURL?: string;
  isCooked: boolean;
  cookedAt?: Timestamp;
};
```

### `savedRestaurants` (subcollection)

```typescript
interface SavedRestaurant {
  id: string;
  placeId: string; // Google Places ID
  name: string;
  address: string;
  coordinates: {
    lat: number;
    lng: number;
  };
  rating: number;
  priceLevel?: number;
  cuisineTypes: string[];
  savedAt: Timestamp;
  notes?: string;
  isFavorite: boolean;
}
```

## 칈ndices Firestore Necesarios

```json
{
  "indexes": [
    {
      "collectionGroup": "recipes",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "isFavorite", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "pantry",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "zone", "order": "ASCENDING" },
        { "fieldPath": "category", "order": "ASCENDING" }
      ]
    }
  ]
}
```

## Reglas de Seguridad

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Subcollections
    match /users/{userId}/recipes/{recipeId} {
      allow read, write: if isOwner(userId);
    }

    match /users/{userId}/pantry/{itemId} {
      allow read, write: if isOwner(userId);
    }

    match /users/{userId}/mealPlans/{planId} {
      allow read, write: if isOwner(userId);
    }

    match /users/{userId}/savedRestaurants/{restaurantId} {
      allow read, write: if isOwner(userId);
    }
  }
}
```
